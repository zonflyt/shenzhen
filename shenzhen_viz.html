<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>深圳城市扩张：时空双维可视化</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+SC:wght@300;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            background-color: #020617; /* 极深蓝 */
            font-family: 'Noto Sans SC', sans-serif;
            color: #e2e8f0;
            overflow: hidden;
            margin: 0;
        }
        
        .digital-font { font-family: 'Orbitron', sans-serif; }
        
        /* 霓虹辉光 */
        .neon-box {
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.3), inset 0 0 20px rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        /* 加载动画 */
        .loader {
            border: 3px solid #1e293b;
            border-top: 3px solid #06b6d4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* HUD 界面风格 */
        .hud-panel {
            background: rgba(2, 6, 23, 0.85);
            backdrop-filter: blur(8px);
            border-left: 2px solid #06b6d4;
        }

        #year-big {
            -webkit-text-stroke: 1px rgba(255,255,255,0.1);
        }
    </style>
</head>
<body class="w-full h-screen relative">

    <!-- 地图容器 (全屏背景) -->
    <div id="map-container" class="absolute inset-0 z-0"></div>

    <!-- 加载提示 -->
    <div id="loading" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-slate-900">
        <div class="loader mb-4"></div>
        <div class="text-cyan-500 tracking-widest text-sm">LOADING GEO DATA...</div>
    </div>

    <!-- 顶部标题 -->
    <div class="absolute top-0 left-0 p-6 z-10 pointer-events-none">
        <h1 class="text-4xl font-bold text-white tracking-wider digital-font">SHENZHEN <span class="text-cyan-400">EVOLUTION</span></h1>
        <p class="text-gray-400 text-sm mt-1">Spatial-Temporal Visualization of Built-up Area (1985-2020)</p>
    </div>

    <!-- 巨大的年份背景 (装饰) -->
    <div id="year-big" class="absolute top-4 right-10 text-[8rem] font-bold text-transparent pointer-events-none z-0 opacity-20 digital-font transition-all duration-300">
        1985
    </div>

    <!-- 底部控制面板与图表 -->
    <div class="absolute bottom-0 left-0 right-0 h-1/3 bg-gradient-to-t from-black via-slate-900/90 to-transparent z-10 flex flex-col justify-end p-6">
        
        <div class="flex gap-6 items-end max-w-7xl mx-auto w-full">
            
            <!-- 左侧：控制与数据 -->
            <div class="w-64 flex-shrink-0 neon-box bg-slate-900/80 p-4 rounded-lg backdrop-blur mb-2">
                <div class="flex justify-between items-baseline mb-2">
                    <span class="text-gray-400 text-xs uppercase">Total Area</span>
                    <span id="area-val" class="text-3xl font-bold text-cyan-400 digital-font">47</span>
                </div>
                <div class="w-full bg-gray-700 h-1 rounded-full mb-4 overflow-hidden">
                    <div id="progress-bar" class="bg-cyan-500 h-full w-[5%] transition-all duration-300"></div>
                </div>
                
                <div class="flex gap-2">
                    <button id="play-btn" class="flex-1 bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded text-xs transition-colors tracking-widest">
                        START
                    </button>
                    <button id="reset-btn" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-3 rounded text-xs transition-colors">
                        ↺
                    </button>
                </div>
                <div id="status-text" class="mt-3 text-[10px] text-gray-500 leading-tight">
                    Ready to simulate urbanization process.
                </div>
            </div>

            <!-- 右侧：折线图 -->
            <div class="flex-1 h-48 neon-box bg-slate-900/80 rounded-lg backdrop-blur relative">
                <div id="chart-container" class="w-full h-full p-2"></div>
            </div>

        </div>
    </div>

    <script>
        // --- 1. 数据准备 (含插值) ---
        const rawData = [
            { year: 1985, value: 47.334 },
            { year: 1986, value: 52.8 }, { year: 1987, value: 58.2 }, 
            { year: 1988, value: 63.7 }, { year: 1989, value: 69.1 }, 
            { year: 1990, value: 74.675 }, { year: 1991, value: 98.335 },
            { year: 1992, value: 120.094 }, { year: 1993, value: 164.306 },
            { year: 1994, value: 195.26 }, { year: 1995, value: 227.776 },
            { year: 1996, value: 265.661 }, { year: 1997, value: 305.765 },
            { year: 1998, value: 342.819 }, { year: 1999, value: 381.357 },
            { year: 2000, value: 425.669 }, { year: 2001, value: 446.721 },
            { year: 2002, value: 479.103 }, { year: 2003, value: 510.539 },
            { year: 2004, value: 543.763 }, { year: 2005, value: 584.825 },
            { year: 2006, value: 615.194 }, { year: 2007, value: 635.838 },
            { year: 2008, value: 652.386 }, { year: 2009, value: 669.514 },
            { year: 2010, value: 681.608 }, { year: 2011, value: 691.4 },
            { year: 2012, value: 699.509 }, { year: 2013, value: 711.531 },
            { year: 2014, value: 730.2 }, { year: 2015, value: 765.4 },
            { year: 2016, value: 802.1 }, { year: 2017, value: 840.5 },
            { year: 2018, value: 880.2 }, { year: 2019, value: 912.8 },
            { year: 2020, value: 927.96 }
        ];

        // 深圳各区域的大致中心点（用于模拟生长重心）
        const centers = {
            luohu: [114.13, 22.55],   // 罗湖 (最早发展)
            futian: [114.055, 22.54], // 福田 (早期发展)
            nanshan: [113.93, 22.53], // 南山 (中期发展)
            baoan: [113.88, 22.58],   // 宝安 (中后期)
            longgang: [114.24, 22.72],// 龙岗 (中后期)
            longhua: [114.02, 22.65], // 龙华 (后期)
            guangming: [113.92, 22.76]// 光明 (后期)
        };

        // --- 2. 模拟粒子生成算法 ---
        // 这是一个"伪"空间分布算法，用来在视觉上模拟城市扩张的感觉
        // 它不代表真实历史GIS数据，但能反映"扩张趋势"
        function generateParticlesForYear(year, totalArea) {
            const particleCount = Math.floor(totalArea * 1.5); // 粒子密度系数
            const points = [];
            
            for (let i = 0; i < particleCount; i++) {
                let center;
                let spread = 0.04; // 扩散程度

                const rand = Math.random();

                // 根据年份决定粒子大概落在哪里 (模拟城市重心转移)
                if (year < 1990) {
                    // 85-90: 集中在罗湖(60%)、福田(30%)、蛇口(10%)
                    if (rand < 0.6) center = centers.luohu;
                    else if (rand < 0.9) center = centers.futian;
                    else center = centers.nanshan; 
                    spread = 0.03; 
                } else if (year < 2000) {
                    // 90-00: 福田中心区形成，南山起步，罗湖饱和
                    if (rand < 0.3) center = centers.luohu;
                    else if (rand < 0.65) center = centers.futian;
                    else if (rand < 0.85) center = centers.nanshan;
                    else center = centers.longgang; // 龙岗开始
                    spread = 0.05;
                } else if (year < 2010) {
                    // 00-10: 关内外一体化，宝安、龙岗、龙华大发展
                    if (rand < 0.15) center = centers.luohu;
                    else if (rand < 0.35) center = centers.futian;
                    else if (rand < 0.55) center = centers.nanshan;
                    else if (rand < 0.75) center = centers.baoan;
                    else center = centers.longgang;
                    spread = 0.08;
                } else {
                    // 10-20: 全面开花，光明、坪山加入
                    if (rand < 0.1) center = centers.luohu;
                    else if (rand < 0.25) center = centers.futian;
                    else if (rand < 0.45) center = centers.nanshan;
                    else if (rand < 0.65) center = centers.baoan;
                    else if (rand < 0.8) center = centers.longhua;
                    else center = centers.guangming;
                    spread = 0.1;
                }

                // 高斯分布模拟自然聚落
                const u = 1 - Math.random();
                const v = Math.random();
                const radius = spread * Math.sqrt(-2 * Math.log(u));
                const theta = 2 * Math.PI * v;
                
                const lng = center[0] + radius * Math.cos(theta);
                const lat = center[1] + radius * Math.sin(theta);

                // 简单的边界检查 (粗略限制在深圳经纬度范围内，避免飞到海上太远)
                if (lng > 113.7 && lng < 114.65 && lat > 22.4 && lat < 22.85) {
                    points.push([lng, lat, 1]); // value 1 for intensity
                }
            }
            return points;
        }

        // --- 3. ECharts 初始化 ---
        const mapChart = echarts.init(document.getElementById('map-container'));
        const lineChart = echarts.init(document.getElementById('chart-container'));
        let geoJsonData = null;

        // 获取深圳地图数据
        fetch('https://geo.datav.aliyun.com/areas_v3/bound/440300_full.json')
            .then(response => response.json())
            .then(geoJson => {
                geoJsonData = geoJson;
                document.getElementById('loading').style.display = 'none';
                initCharts();
            })
            .catch(error => {
                console.error("Map load failed", error);
                document.getElementById('loading').innerHTML = "<span class='text-red-500'>地图数据加载失败<br>Map Data Load Error</span>";
            });

        function initCharts() {
            echarts.registerMap('shenzhen', geoJsonData);

            // 地图配置
            const mapOption = {
                geo: {
                    map: 'shenzhen',
                    roam: false,
                    zoom: 1.2,
                    itemStyle: {
                        areaColor: '#0f172a',
                        borderColor: '#1e293b',
                        borderWidth: 1
                    },
                    emphasis: {
                        itemStyle: { areaColor: '#1e293b' },
                        label: { show: false }
                    }
                },
                series: [
                    {
                        type: 'scatter', // 使用散点图模拟建筑群
                        coordinateSystem: 'geo',
                        data: [], // 初始为空
                        symbolSize: 2,
                        itemStyle: {
                            color: '#22d3ee', // Cyan
                            shadowBlur: 5,
                            shadowColor: '#22d3ee'
                        },
                        // 大量点优化
                        large: true,
                        largeThreshold: 500
                    },
                    {
                        type: 'effectScatter', // 高亮重点区域 (增加动感)
                        coordinateSystem: 'geo',
                        data: [],
                        symbolSize: 10,
                        rippleEffect: { brushType: 'stroke' },
                        itemStyle: { color: '#facc15' }
                    }
                ]
            };
            mapChart.setOption(mapOption);

            // 折线图配置
            const lineOption = {
                grid: { top: 10, right: 10, bottom: 20, left: 40 },
                xAxis: { type: 'category', data: rawData.map(d => d.year), axisLabel: { show: false }, axisTick: { show: false }, axisLine: { show: false } },
                yAxis: { type: 'value', splitLine: { show: false }, axisLabel: { color: '#64748b' } },
                series: [{
                    type: 'line',
                    data: rawData.map(d => d.value),
                    showSymbol: false,
                    smooth: true,
                    lineStyle: { color: '#06b6d4', width: 2 },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(6, 182, 212, 0.5)' },
                            { offset: 1, color: 'rgba(6, 182, 212, 0)' }
                        ])
                    },
                    markLine: {
                        symbol: 'none',
                        label: { show: false },
                        lineStyle: { color: '#fff', type: 'solid', width: 1 },
                        data: [] // 动态更新垂直线
                    }
                }]
            };
            lineChart.setOption(lineOption);
        }

        // --- 4. 动画控制 ---
        let currentIndex = 0;
        let isPlaying = false;
        let timer = null;
        
        const yearBig = document.getElementById('year-big');
        const areaVal = document.getElementById('area-val');
        const statusText = document.getElementById('status-text');
        const progressBar = document.getElementById('progress-bar');
        const playBtn = document.getElementById('play-btn');

        function updateFrame(index) {
            const data = rawData[index];
            const percent = ((index + 1) / rawData.length) * 100;

            // 1. 更新 UI
            yearBig.innerText = data.year;
            areaVal.innerText = Math.round(data.value);
            progressBar.style.width = `${percent}%`;

            // 2. 更新地图粒子
            const particles = generateParticlesForYear(data.year, data.value);
            // 简单的"热点"逻辑：每年随机选几个高亮
            const effects = particles.filter((_, i) => i % 150 === 0); 

            mapChart.setOption({
                series: [
                    { data: particles },
                    { data: effects }
                ]
            });

            // 3. 更新折线图指示器
            lineChart.setOption({
                series: [{
                    markLine: {
                        data: [{ xAxis: index }]
                    }
                }]
            });

            // 更新状态文案
            if (data.year === 1992) statusText.innerText = "1992: Deng's Southern Tour triggers boom.";
            else if (data.year === 2010) statusText.innerText = "2010: SEZ expansion (Guan-wai integrated).";
            else statusText.innerText = `Simulating Urban Density for ${data.year}...`;
        }

        function play() {
            if (currentIndex >= rawData.length) currentIndex = 0;
            
            isPlaying = true;
            playBtn.innerText = "PAUSE";
            playBtn.classList.add('bg-red-600', 'hover:bg-red-500');
            playBtn.classList.remove('bg-cyan-600', 'hover:bg-cyan-500');

            timer = setInterval(() => {
                updateFrame(currentIndex);
                currentIndex++;
                if (currentIndex >= rawData.length) {
                    stop();
                }
            }, 250); // 250ms per year
        }

        function stop() {
            isPlaying = false;
            clearInterval(timer);
            playBtn.innerText = "RESTART";
            playBtn.classList.remove('bg-red-600', 'hover:bg-red-500');
            playBtn.classList.add('bg-cyan-600', 'hover:bg-cyan-500');
        }

        playBtn.addEventListener('click', () => {
            if (isPlaying) stop();
            else play();
        });

        document.getElementById('reset-btn').addEventListener('click', () => {
            stop();
            currentIndex = 0;
            updateFrame(0);
            playBtn.innerText = "START";
        });

        window.addEventListener('resize', () => {
            mapChart.resize();
            lineChart.resize();
        });

    </script>
</body>
</html>